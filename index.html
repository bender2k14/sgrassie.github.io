
<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Stuart Grassie's Blog">
    <meta name="author" content="Stuart Grassie">
    <meta name="keywords" content="annoyance,blog,Books,build script,C#,cathartic,Coding,delphi,design patterns,DI,Dropbox,editing,euler,exception,Git,github-api,IoC,Java,jQuery,linux,log4net,Logging,nancy,News,npoco,PHP,Plugin Manager,Powershell,prism,Project Euler,psake,random,RestSharp,sandra.snow,self pity,snow,Source Control,structuremap,thoughts,Uncategorized,vim,winner,wpf" />
    <title>temporalcohesion.co.uk</title>

    <!-- Bootstrap core CSS -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <!-- Custom styles for this template -->
    <link href="/stylesheets/custom-styles.css" rel="stylesheet" type="text/css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="canonical" href="http://www.temporalcohesion.co.uk/" />
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">temporalcohesion.co.uk</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/contact">Contact</a></li>
            <li><a href="/archive">Archives</a></li>
          </ul>
	  <ul class="nav navbar-nav navbar-right">
		  <li><a href="http://twitter.com/stugrassie"><img src="/images/twitter.png"></a></li>
		  <li><a href="http://facebook.com/sgrassie"><img src="/images/facebook.png"></a></li>
		  <li><a href="http://uk.linkedin.com/in/sgrassie/"><img src="/images/linkedin.png"></a></li>
	  </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">
	

<div class="post">
	<h1 class="title">
		<a href="/2015/03/17/fluent-npoco-mappings-with-structuremap/">Fluent NPoco mappings with StructureMap</a> <small>Tuesday, 17 Mar, 2015</small>
	</h1>
   <div class="meta">
	   <ul class="list-unstyled list-inline">
			<li><a href="/category/npoco" title="npoco">npoco</a></li>
			<li><a href="/category/structuremap" title="structuremap">structuremap</a></li>
	   </ul>
   </div>
            
   
   
<p>I like using <a href="https://github.com/schotime/NPoco">NPoco</a>, it's a really nice library that allows you stop having to write raw ADO.NET. Recently I just switched one of my projects at work to use the Fluent Mapping features, essentially so that my POCO's do not need to have the mapping attributes in them.</p>

<p>I started wth the example on the <a href="https://github.com/schotime/NPoco/wiki/Fluent-mappings-including-conventional">NPoco wiki</a> of creating a database factory, and adding the mapping class to the fluent configuration. As the number of mapping classes has grown, this has quickly become unwieldy and a bit of a maintainance issue.</p>

<p>As I already utilise Structuremap in the application, I wanted to configure it to automatically pick up my mapping classes and build the configuration object for me. This is easy to in the registry:</p>

<pre><code>public DefaultRegistry()
{
    Scan(
        scan =&gt;
        {
            scan.TheCallingAssembly();
            scan.WithDefaultConventions();
            scan.With(new ControllerConvention());
            scan.AddAllTypesOf&lt;IMap&gt;();
        });

    For&lt;FluentConfig&gt;().Use(context =&gt; FluentMappingConfiguration.Configure(context.GetAllInstances&lt;IMap&gt;().ToArray()));
    For&lt;DatabaseFactory&gt;().Singleton().Use&lt;DatabaseFactory&gt;();
    For&lt;IDatabase&gt;().HttpContextScoped().Use(context =&gt; context.GetInstance&lt;DatabaseFactory&gt;().GetDatabase());
}
</code></pre>

<p>The mapping classes must inherit from <code>Map&lt;T&gt;</code>, which itself inherits from <code>IMap</code>. Thus we can confidently add all types of <code>IMap</code> in the scan.</p>

<p>Then an instance of <code>FluentConfig</code> must be registered, which can be done with an overload of <code>.Use</code>, from which we get the StructureMap context and pull out all the types of IMap which have been found and pass it to the static <code>.Configure</code> method of the <code>FluentMappingConfiguration</code>, which constructs the instance.</p>

<p>The <code>DatabaseFactory</code> (see below) is then registered, and it accepts a 'FluentConfig' instance in its constructor. As per the original example on the NPoco wiki, it is marked as a singleton to ensure that only one instance is created, so that the mappings do not get registered more than once. I don't know what would happen if the mappings were to be registered more than once, but I assume that it would be a Bad Thing&trade;.</p>

<p>Then, for the NPoco <code>IDatabase</code> instance that we register, we want to always create it using the instance of the <code>DatabaseFactory</code> that has already been registered, which again is accessible using the overload of <code>.Use</code> to get the Structuremap context. It's marked as <code>.HttpContextScoped()</code>, but I'm honestly not sure if that's required or not given that I'm using <code>Structuremap.MVC5</code> nested containers.</p>

<p>For completeness, here is the <code>DatabaseFactory</code>:</p>

<pre><code>public class DatabaseFactory
{
    private static NPoco.DatabaseFactory _internalFactory;

    public DatabaseFactory(FluentConfig fluentConfig)
    {
        Configure(fluentConfig);
    }

    private static void Configure(FluentConfig fluentConfiguration)
    {
        _internalFactory = NPoco.DatabaseFactory.Config(x =&gt;
        {
            x.UsingDatabase(() =&gt; new Database("ConnectionString"));
            x.WithFluentConfig(fluentConfiguration);
        });
    }

    public NPoco.Database GetDatabase()
    {
        return _internalFactory.GetDatabase();
    }
}
</code></pre>
 
   <hr />
</div><!--/.post-->
<div class="post">
	<h1 class="title">
		<a href="/2015/03/08/learned-so-much-about-vim-that-i-should-already-know/">Learned so much about Vim that I should already know</a> <small>Sunday, 08 Mar, 2015</small>
	</h1>
   <div class="meta">
	   <ul class="list-unstyled list-inline">
			<li><a href="/category/vim" title="vim">vim</a></li>
	   </ul>
   </div>
            
   
   
<p>I've been a user of Vim for several years now. I use it as my go-to standard editor. As I primarily write C# code, I obviously use Visual Studio, a lot, and I have the wonderful <a href="https://visualstudiogallery.msdn.microsoft.com/59ca71b3-a4a3-46ca-8fe1-0e90e3f79329">VsVim</a> extension installed, which provides a lot of the power of Vim, from within Visual Studio.</p>

<p>I thought I was pretty good at using Vim, until the other day when I saw Vim being used in some screencasts and I immediately thought that I suck at using Vim.</p>

<p>It turns out, that I learned enough about using Vim that got me a good increase in productivity, that I basically stopped learning how to use it. My brain must have decided that I learned all I needed to know to get me through my day, and stopped me wanting to learn anymore.</p>

<p>I have now found a great source of screencasts about using Vim, <a href="http://derekwyatt.org/vim/tutorials/">here</a>, which are split into Beginner, Intermediate and Advanced. I learned how to do new stuff with Vim that is in the first beginner video.</p>

<p>I wish that I had found these videos several years ago when I was first starting out with Vim, as watching them then would probably have saved me a lot of time over the last several years.</p>
 
   <hr />
</div><!--/.post-->
<div class="post">
	<h1 class="title">
		<a href="/2014/10/22/about-those-view-locator-conventions/">About those view locator conventions</a> <small>Wednesday, 22 Oct, 2014</small>
	</h1>
   <div class="meta">
	   <ul class="list-unstyled list-inline">
			<li><a href="/category/prism" title="prism">prism</a></li>
			<li><a href="/category/wpf" title="wpf">wpf</a></li>
	   </ul>
   </div>
            
   
   
<p>As I mentioned in a previous post, I do not like some of the default PRISM view location conventions.</p>

<p>As a refresher, these are:</p>

<ul>
<li>View models to be located in a folder called ViewModel, named MyAwesomeViewModel</li>
<li>Views to be located in a folder called Views, named MyAwesome</li>
</ul>

<p>It's the view naming that I don't like: In my world (which is based on Caliburn.Micro and ReactiveUI), views should be named MyAwesomeView. This is a simple distinction, but an important one for me because I automatically expect view names to end in View.</p>

<p>Fortunately in PRISM 5, this is easy to change:</p>

<pre><code>ViewModelLocationProvider.SetDefaultViewTypeToViewModelTypeResolver(viewType =&gt;
{
    var viewName = viewType.FullName;
    var viewAssemblyName = viewType.GetTypeInfo().Assembly.FullName;
    var viewModelName = string.Format(CultureInfo.InvariantCulture, " {0}Model, {1} ", viewName.Replace("Views", "ViewModels"), viewAssemblyName);
    return Type.GetType(viewModelName);
});
</code></pre>

<p>We get the full name of the view, and the full name of the assembly, and then replace "Views" for the "ViewModels" folder, and add "Model" to the end. I would call this somewhere in your applications startup, such as in the bootstrapper <code>Run</code>.</p>

<h2>Autowiring</h2>

<p>Something else that you can do in PRISM 5, is autowire the view model and view such that the <code>DataContext</code> of the view is automatically populated. </p>

<pre><code>ViewModelLocationProvider.SetDefaultViewModelFactory(type =&gt; Container.GetInstance(type));
</code></pre>

<p>I'm using StructureMap here (of which I am a big fan), but you should be able to get to work with your favourite IoC library.</p>

<p>This though, means that you have to tell StructureMap about all your views in order for it to be able to resolve them. That's too much messing about remembering having to update a <code>Registry</code> everytime I add a view. StructureMap can solve that for us no problem:</p>

<pre><code>public class ViewRegistrationConvention : IRegistrationConvention
{
    public void Process(Type type, Registry registry)
    {
        if (!type.Name.EndsWith("View") || ! type.IsConcrete()) return ;

        registry.For(typeof(object)).Use(type).Named(type.Name);
    }
}
</code></pre>

<p>Here we say that if the name of the type being resolved ends with "View", and it is a concrete type (i.e. not an abstract class or interface), then add it to the registry.
The trick with PRISM is that it is asking to resolve an <code>object</code> with a specific name, it doesn't try to resolve the type of the view, so adding something to the registry as <code>For&lt;MyAwesomeView&gt;().Use&lt;MyAwesomeView&gt;()</code> won't work, you have to use <code>For(typeof(object))</code> and make it a named instance, using the name of the type. </p>

<p>And then just register the convention when you configure the container:</p>

<pre><code>Container.Configure(configure =&gt;
{
    configure.Scan(scan =&gt;
    {
        ...
        scan.Convention&lt;ViewRegistrationConvention&gt;();
    });
});
</code></pre>

<p>Then from the region manager, you can <code>RequestNavigate("AwesomeRegion", new Uri(typeof(MyAwesomeView)))</code>, or use the extension method in my previous post. </p>
 
   <hr />
</div><!--/.post-->
<div class="post">
	<h1 class="title">
		<a href="/2014/10/20/a-useful-prism-extension-method/">A useful PRISM extension method</a> <small>Monday, 20 Oct, 2014</small>
	</h1>
   <div class="meta">
	   <ul class="list-unstyled list-inline">
	   </ul>
   </div>
            
   
   
<p>I'm doing some work with Microsoft <a href="http://msdn.microsoft.com/en-us/library/gg406140.aspx">Prism</a> at the moment, and once again I've gotten annoyed that <code>RequestNavigate</code> doesn't have a generic overload.</p>

<p>Naturally I had to write it, again:</p>

<p><pre><code>
public static class RegionManagerExtensions
{
    public void RequestNavigate<TView>(this IRegionManager regionManager, string regionName)
    {
        regionManager.RequestNavigate(regionName, new Uri(typeof(TView), UriKind.Relative).Name));
    }
}
</pre></code></p>

<p>the <code>new Uri(typeof(TView)...)</code> works because of the view locator conventions I've implemented.</p>
 
   <hr />
</div><!--/.post-->
<div class="post">
	<h1 class="title">
		<a href="/2014/05/30/how-i-moved-my-blog-to-sandra-now-part2/">How I moved my blog to sandra snow, part two</a> <small>Friday, 30 May, 2014</small>
	</h1>
   <div class="meta">
	   <ul class="list-unstyled list-inline">
			<li><a href="/category/blog" title="blog">blog</a></li>
			<li><a href="/category/sandra.snow" title="sandra.snow">sandra.snow</a></li>
	   </ul>
   </div>
            
   <ul class="snow-series"><li><a href="/2014/03/03/how-i-moved-my-blog-from-wordpress-to-snow/">How I moved my blog from wordpress to snow, part one</a></li><li>How I moved my blog to sandra snow, part two</li></ul>
   
<p>Once you have liberated your content from Wordpress, getting it generated by Snow is fairly trivial.</p>

<ol>
<li>Compile <a href="https://github.com/Sandra/Sandra.Snow">Snow</a>.</li>
<li>Copy <a href="https://github.com/Sandra/Sandra.Snow/tree/master/SnowSite">SnowSite</a> somewhere.</li>
<li>Copy the fresh Snow files into a sub folder of the folder you created in #2. Mine is called <code>_compiler</code> and contains <code>snow.exe</code>, <code>Nancy.dll</code>, <code>Nancy.ViewEngines.Razor.dll</code> and <code>Nancy.Testing.dll</code>.</li>
<li>Clean out the _posts folder, as it contains the markdown for <a href="http://www.philiphaydon.com">philiphaydon.com</a>, who is the creator of Snow.</li>
<li>Edit the <code>snow.config</code>. You'll want to change things to reflect your details, e.g. your name, email, blog title etc. The urlFormat is important. Mine is set to <code>yyyy/MM/dd/slug</code>, which follows the same pattern as my old wordpres blog. This important because it means that the blog posts be generated with the same url, which means I don't have to dick about with 302 redirects or any of that shit.</li>
<li>Compile your site. This is best achieved via a batch file which should live in the folder above the \Snow folder you created in #2. The batch file will look something like:</li>
</ol>

<pre><code>echo off
cls
.\Snow\_compiler\Snow.exe config=.\Snow\ debug=true server=true
</code></pre>

<p>Here, we tell snow where to find the <code>snow.config</code> file, specify that we'd like snow to give us some debug output to the console window, and that we want it to fire up its built in web server so that we can preview our site.</p>

<p>Name the batch file <code>compile.snow.bat</code> so that Snow doesn't delete it when it compiles your site. When you now execute the batch file, Snow should compile your blog and fire it up in your default webbrowser, so you can check it out, and make sure it looks ok.</p>

<p>At this point, you should be ready to deploy your site somewhere.</p>
 
   <hr />
</div><!--/.post-->

  <!-- Pagination links -->
  <div id="post-pagination" class="pagination">

   

      <!--<a href="/">Previous Page</a>-->

    <p class="previous">
      <a href="/page2">Next Page</a>
    </p>

  </div>


        
        <hr />
        <footer>
            <p>&copy; temporalcohesion.co.uk 2014 | Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a></p>
        </footer>

    </div><!-- /.container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>

    <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-9870754-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>

    <script src="/javascripts/prettify.js"></script>
    <script type='text/javascript'>
      $(function () {
        $("pre code").parent().each(function () {
          if (!$(this).hasClass("prettyprint")) {
            $(this).addClass("prettyprint");
            a = true
          }
        });

        prettyPrint();
      });
    </script>
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?skin=sons-of-obsidian"></script>

    <script src="/javascripts/cohesion.js"></script>
</body>
</html>
