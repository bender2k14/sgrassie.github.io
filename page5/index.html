
<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Stuart Grassie's Blog">
    <meta name="author" content="Stuart Grassie">
    <meta name="keywords" content="annoyance,blog,Books,build script,C#,cathartic,Coding,delphi,design patterns,DI,Dropbox,editing,euler,exception,git,Git,github-api,IoC,Java,jQuery,linux,log4net,Logging,nancy,News,PHP,Plugin Manager,Powershell,Project Euler,psake,random,RestSharp,sandra.snow,self pity,snow,Source Control,thoughts,Uncategorized,vim,winner" />
    <title>temporalcohesion.co.uk</title>

    <!-- Bootstrap core CSS -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap-theme.min.css">

    <!-- Custom styles for this template -->
    <link href="/stylesheets/custom-styles.css" rel="stylesheet" type="text/css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="canonical" href="http://www.temporalcohesion.co.uk/page5/" />
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">temporalcohesion.co.uk</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/contact">Contact</a></li>
            <li><a href="/archive">Archives</a></li>
          </ul>
	  <ul class="nav navbar-nav navbar-right">
		  <li><a href="http://twitter.com/stugrassie"><img src="/images/twitter.png"></a></li>
		  <li><a href="http://facebook.com/sgrassie"><img src="/images/facebook.png"></a></li>
		  <li><a href="http://uk.linkedin.com/in/sgrassie/"><img src="/images/linkedin.png"></a></li>
	  </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">
	

<div class="post">
	<h1 class="title"><a href="/2010/11/01/github-c-api-handling-the-response-with-restsharp/">Github C# API: Handling the response with RestSharp</a> <small>Monday, 01 Nov, 2010</small></h1>
   <div class="meta">
   </div>
            
   
   
<p>Once we make a request to Github.com with <a title="RestSharp.org" href="http://restsharp.org/" target="_blank">RestSharp</a>, we get a response, and RestSharp gives us a <a title="RestResponse class in RestSharp on github.com" href="http://github.com/johnsheehan/RestSharp/blob/master/RestSharp/RestResponse.cs" target="_blank">RestResponse</a> object, with which we can do something with the content. The content will be in the format that we specified when we made the request, either JSON, XML or YAML.</p>

<p>Oh crap, complicated string parsing...</p>

<p>RestSharp to the rescue! We don't have to worry about parsing the response content, because RestSharp can do it for us.</p>

<p>What we need to do, is model the response content into a POCO (Plain Old Clr Object):</p>

<pre class="brush: csharp">public class User
{
    public virtual int Id { get; set; }
    public virtual string Login { get; set; }
    public virtual string Name { get; set;}

    ...
}</pre>

<p>Note that in this <a title="User class in the csharp-github-api project" href="http://github.com/sgrassie/csharp-github-api/blob/master/csharp-github-api/Models/User.cs" target="_blank">User</a> class, I've made the properties virtual, this is not necessary for RestSharp to function correctly, it's more habit on my part from working with NHibernate; however it does mean you can reuse the same models with NHibernate (if you wanted to do something like store the response in a database, for example).</p>

<p>Then we need to modify our client such that when we execute the request, we instruct RestSharp to construct an instance of the User object. Create the client in the usual way and also create the request in the usual way. The magic is in how the client executes the request:</p>

<pre class="brush: csharp">var request = new RestRequest
                  {
                      Resource = string.Format("/user/show/{0}", username),
                      RootElement = "user"
                  };

var response = client.Execute&lt;User&gt;(request);

var user = response.Data;</pre>

<p>As you can see, the Execute method has a generic overload. Internally, RestSharp detects that because we have used this overload, we want to deserialise the response content into an object of the given type, and it performs the deserialisation and constructs an instance of the object. The way that it does this is by looking at the Content-Type header in the response, and it uses the correct deserialiser depending upon the Content-Type. You can see more detail about this on <a href="http://github.com/johnsheehan/RestSharp/blob/master/RestSharp/RestClient.cs" target="_blank">RestSharp's Github project pages</a>.</p>

<p>It is really easy to work with the response from your REST request with RestSharp, you can access the raw string content of the response, or deserialise it into a POCO - it's up to you.</p>
 
   <hr />
</div><!--/.post-->
<div class="post">
	<h1 class="title"><a href="/2010/10/25/lets-write-an-api-library-for-github/">Let's write an API library for Github</a> <small>Monday, 25 Oct, 2010</small></h1>
   <div class="meta">
   </div>
            
   
   
<p>Let's write a C# API library for <a title="Github.com" href="http://www.github.com">github.com</a>.</p>

<p>Github has a <a title="Representational State Transfer on Wikipedia" href="http://en.wikipedia.org/wiki/Representational_State_Transfer">REST</a> base API, the details of which are available at develop.github.com. Before continuing, I should point out that there is an <a title="GitHubSharp on github.com" href="http://github.com/erikzaadi/GithubSharp">existing C# library already available</a>, if you want to use that.</p>

<p>We'll leverage John Sheehan's excellent <a title="johnsheehan's RestSharp on github.com" href="http://github.com/johnsheehan/RestSharp" target="_blank">RestSharp</a> library to do most of the heavy lifting.</p>

<p>Before we can really do anything, the first task at hand is to learn how to work with RestSharp, and how we can make a request and receive a response. Fortunately, RestSharp makes it really easy, and there are excellent resources on the project's wiki page which explain how to do things. Let's see a quick example:</p>

<pre class="brush: csharp">[Test]
public void MakeBasicRequestToTwitterWithRestSharp()
{
    var client = new RestClient("http://api.twitter.com");
    client.UserAgent = "TemporalCohesion.TwitterApi";

    var request = new RestRequest();
    request.Resource = "statuses/public_timeline.json";

    var response = client.Execute(request);

    if (response.StatusCode == HttpStatusCode.OK)
    {
        String content = response.Content;

        Assert.That(content, Is.Not.Null);
    }
    else
    {
        Assert.Fail(response.StatusDescription);
    }
}</pre>

<p>Here we are making an authenticated request to Twitter, asking for the public timeline in JSON format, but, the same code can easily be applied to github.com. We'll see more of that later. First we create the client object, and then create the request object - telling it what resource to actually request, and then we execute the request using the client, and then do something with the response. Pretty straightforward, huh?</p>

<p>There is quite a lot that we can do with the Github API at this point, although you'll quickly see that to do anything really interesting (i.e. modifying your github account, or creating/forking repo's) requires you to be authenticated. Fortunately for us, Github uses HTTP Basic Authentication, and, RestSharp has a HttpBasicAuthenticator class, and if you put the two together, you can make an authenticated request to Github like this:</p>

<pre class="brush: csharp">var client = new RestClient
                 {
                     BaseUrl = "https://github.com/api/v2/json",
                     Authenticator = new HttpBasicAuthenticator("test", "test")
                 };</pre>

<p>After we set the authenticator, RestSharp takes care of making sure that the headers of the requests we make to Github's API contain the necessary authentication which identifies us to Github. You'll note that the BaseUrl here is set to https://github.com/..., so that we can take advantage of SSL. You can can access public data via normal http://, but if we are going to do anything that requires authentication, it will be best if we choose to use https://</p>

<p>Github also provide us with an API key. This is a unique key which identifies us to Github, and give our requests a little bit more security. We can't set this key with RestSharp, as we need to modify the way the authorization header is generated when we make a request. What we can do though, is to implement our own <a title="RestSharp's IAuthenticator class" href="http://github.com/johnsheehan/RestSharp/blob/master/RestSharp/Authenticators/IAuthenticator.cs" target="_blank">IAuthenticator</a> to do handle it for us. You can see <a title="GitHubAuthenticator in the csharp-github-api" href="http://github.com/sgrassie/csharp-github-api/blob/master/csharp-github-api/GitHubAuthenticator.cs" target="_blank">my implementation</a> up on Github. It's fairly straightforward - I still wanted to allow basic username:password authentication, as well as username/token: authentication for Github.com. Let's create a unit test to check everything is working OK.</p>

<p>How do we know if we have made an authenticated request successfully? If you make a request to Github for a user, and you are authenticated as that user, then as well as the standard user response, there is some additional information included in the responses that only you, as the authenticated user, can see. And we can check for this information in the response:</p>

<pre class="brush: csharp">[Test]
public void MakeAuthenticatedRequest()
{
    var restRequest = new RestRequest
            {
                Resource = "/user/show/sgrassie"
            };

    var client = new RestClient
                     {
                         BaseUrl = "http://github.com/api/v2/json",
                         Authenticator = new GitHubAuthenticator(_secretsHandler.Username, _secretsHandler.Password, true)
                     };

    var response = client.Execute(restRequest);

    Assert.That(response.Content, Is.StringContaining("total_private_repo_count"));
}</pre>

<p>The unit test is pretty straightforward, I make a request object which will get my user account, I authenticate the request and then execute it. Then I can simply check that the response content contains "total<em>private</em>repo_count" - this would only be returned if the request was an authenticated request.</p>

<p>One thing you might notice in the test is that in the GitHubAuthenticator constructor, I get my username and password/api token from the <em>_secretsHandler</em> object, an instance of a class I've written which will load my username, password and api key from an XML file. This is so that I don't have to put my Github.com password and API key into the project's Github repo, because that would be bad.</p>
 
   <hr />
</div><!--/.post-->
<div class="post">
	<h1 class="title"><a href="/2010/07/21/unit-testing-events/">Unit Testing Events</a> <small>Wednesday, 21 Jul, 2010</small></h1>
   <div class="meta">
   </div>
            
   
   
<p>Recently I have had to unit test some events in an application I work on. I came up with a workable solution, but I didn�t really like the way it was working, and it just looked ugly. So I did a little digging on Google, and <a href="http://stackoverflow.com/questions/248989/unit-testing-that-an-event-is-raised-in-c">found this helpful question on StackOverflow</a>.</p>

<p>Here is my take it. I�m putting it here so I can find easily find it again. Basically it�s the same, but I�m using a lambda to create my anonymous delegate:</p>

<pre class="brush: csharp">[Test]
public void UnitTestNodeChanged()
{
 var receivedEvents = new List&lt;XmlNodeChangedEventArgs&gt;();
 var document = new XmlDocument();

 document.NodeChanged += ((sender, e) =&gt; receivedEvents.Add(e));
 document.Load("C:file.xml");

 Assert.That(receivedEvents.Count, Is.EqualTo(1));
}</pre>

<p>Nice and short, and to the point. We can test the fact that the event was raised (or not); how many times the event was raised; and, we can test the event arguments.</p>

<p>I like it. Some people may not, but it suits my purposes.</p>
 
   <hr />
</div><!--/.post-->
<div class="post">
	<h1 class="title"><a href="/2010/03/31/well-i-certainly-didnt-know-that-word-could-do-this/">Well I certainly didn�t know that Word could do this</a> <small>Wednesday, 31 Mar, 2010</small></h1>
   <div class="meta">
   </div>
            
   
   
<p><p>Whilst I was watching football I had this amazing idea that I was going to write a plugin for Word that would let you write blog posts and publish them onto your blog. I literally had no idea that Word would have this baked in by default.
</p><p>Obviously I've had to test this out immediately.
</p></p>
 
   <hr />
</div><!--/.post-->
<div class="post">
	<h1 class="title"><a href="/2010/03/23/revisting-the-project-euler-problem-runner/">Revisting the Project Euler problem runner</a> <small>Tuesday, 23 Mar, 2010</small></h1>
   <div class="meta">
   </div>
            
   
   
<p>I'm sure that you must have heard about <a title="Project Euler website" href="http://projecteuler.net/" target="_blank">Project Euler</a>, which "is a series of challenging mathematical/computer programming problems that  will require more than just mathematical insights to solve". I have blogged about tackling the Project Euler problems <a href="http://temporalcohesion.co.uk/2008/08/22/building-the-project-euler-framework-part-1/">before</a>, and at the time, I developed a simple program to try to automate running the problems.</p>

<p>That was about 18 months ago, I've learned a lot since then and I think that it is high time to take a look back at the code and see if I can spot if there is any room for improvement.</p>

<h2>The current project</h2>

<p>[caption id="attachment_191" align="alignleft" width="240" caption="Current structure"]<a href="http://temporalcohesion.co.uk/wp-content/uploads/2010/03/eulerprojectold.png"><img class="size-medium wp-image-191 " title="eulerprojectold" src="http://temporalcohesion.co.uk/wp-content/uploads/2010/03/eulerprojectold-300x241.png" alt="The current structure of the project" width="240" height="193" /></a>[/caption]</p>

<p>Let's have a look at how I structured the project when I set it up. The first thing that you will notice, is that I messed up the package names. It should be "uk.co", and not "co.uk", according to the <a title="Java Language specification on sun.com" href="http://java.sun.com/docs/books/jls/third_edition/html/packages.html#7.7" target="_blank">Java language specification</a>. A minor point, and not really a big deal, we can easily sort it out.</p>

<p>Something else I did, was lump everything together into the same project and package - the runner program, the utils (e.g. helper classes that you write as you progress through problems), resources and the problems themselves.</p>

<p>I don't think that this was necessarily a bad idea at the time, I don't think that it is inherintly a bad idea now, it's logical for everything to share the same package. Or should I say, it <em>was </em>logical for everything to share the same package.</p>

<p>I am going to put the code for the problem runner onto Github, but I don't want to share the answers to the problems. To answer your question, I think that it goes against the point of Project Euler, that of having a set of problems that the inquisitive person can solve with some math and programming. I have also found that the problems also help in getting comfortable with the syntax of a new programming language - after all the solutions to the problems remain the same, however the implementation is subtley different depending on the language being used.</p>

<h2>Re-Design</h2>

<p>Examining the current code and design, we can immediately identify some changes which we are going to make� I'm going to seperate the uk.co.temporalcohesion.euler package into three packages, which are more distinct from each other, but still keep them all in the same project. Why? Well, it is obvious that there are three tasks which we have to manage:</p>

<ol>
    <li>Running problems.</li>
    <li>Provide an API to run the problems.</li>
    <li>Store the problems somewhere</li>
</ol>

<p>To shed some light on my thinking here, lets examine these in more detail. This will also identify areas of possible improvement in the design.</p>

<ol>
<li><p>I want someway of consistenly running a problem (or group of problems) to test the solution(s) to (a) Project Euler problem(s). This is basically our console runner application, which doesn't have to know exactly how this happens, it recieves input, and returns output - how that output is generated is irrelevant to it.</p></li>
<li><p>I want an easy to use API which I can leverage to easily implement the solution to a Project Euler problem, so that I don't have to worry about re-writing all the input/output code over and over again. I also want to be able to share this API, without sharing the answers to the problems themselves.</p></li>
<li><p>I need to have somewhere I can put the answers to the problems, and associated helper classes (Prime number generators, etc) which I can easly backup, and easily run the problems from.</p></li>
</ol>

<p>These are sounding a bit like user stories, and I suppose they are. They can be formalised as so:</p>

<blockquote>
<p style="text-align: left;">As a Problem Solver, I want to run the solution, or group of solutions, to a Project Euler problem.</p>
<p style="text-align: left;">As a problem solver, I want to concentrate implementing the solution to a euler problem, not on implementing input/output for the problem.</p>
<p style="text-align: left;">As a problem solver, I want a place to develop and store the problems, from which I can run the problems to test the solution.</p>
</blockquote>

<p style="text-align: left;">Fairly concise and simple requirements, which we will revisit later. We still have to examine the code in a little more detail so that we can identify exactly what it is we are going to refactor.</p>

<h2 style="text-align: left;">Code review</h2>

<p>The main class to examine is Euler, in Euler.java.� The first to say without even looking at the code, is that the name is fairly awful. Then when we examine the code in more detail, we can see the name is even worse. The class has the main entry point for the program, as well as all the code to actually run the problems. This class is doing everything, there is definately no Seperation of Concerns. It is responsible for accepting user input, loading and running the problems and displaying the output. Wow.</p>

<p>The class is designed around the <a title="Command Patter on Wikipedia" href="http://en.wikipedia.org/wiki/Command_pattern" target="_blank">Command Pattern</a>, and it has worked quite well. Looking at it now, a further two patterns could be used, namely <a title="Strategy patter on Wikipedia" href="http://en.wikipedia.org/wiki/Strategy_pattern" target="_blank">Strategy </a>and <a title="Template method pattern on Wikipedia" href="http://en.wikipedia.org/wiki/Template_method_pattern" target="_blank">Template method</a>.I'm still in two minds about refactoring the design pattern in use, but that discussion can be put off for the time being, as I have other things to concern me.</p>

<p>There are 144 SLoC, not a massive amount, but when you consider the above and what the class should be doing, then it is clearly a bit weighty. There are 7 functions in total, not counting the constructor, not a massive count, but as the SLoC count indicates, some of those functions are a bit long. The worst offender is the following method.</p>

<pre class="lang:java decode:1 " >

private void loadClasses() {
 InputStream fis = null;

 Properties p = new Properties();

 try {
 fis = ClassLoader
 .getSystemResourceAsStream(&amp;quot;co/uk/temporalcohesion/euler/resources/problems.properties&amp;quot;);
 p.load(fis);

 Enumeration&amp;lt;?&amp;gt; e = p.propertyNames();
 while (e.hasMoreElements()) {
 String key = (String) e.nextElement();
 String value = (String) p.getProperty(key);

 Object o = Class.forName(value).newInstance();
 if( ( o != null) &amp;amp;&amp;amp; (o instanceof Problem)){
 Problem problem = (Problem)o;
 problems.put(Integer.parseInt(key), problem);
 }
 }
 }

 catch (FileNotFoundException e) {
 e.printStackTrace();
 } catch (IOException e) {
 e.printStackTrace();
 } catch (ClassNotFoundException e) {
 e.printStackTrace();
 } catch (InstantiationException e) {
 e.printStackTrace();
 } catch (IllegalAccessException e) {
 e.printStackTrace();
 } catch (ClassCastException e) {

 }
 finally {
 try {
 fis.close();
 } catch (IOException e) {
 e.printStackTrace();
 }
 }
 }

</pre>

<p>Wow, that's a lot of code for something which is relatively straightforward. It's not exactly easy to read, and it violoates the Single Responsibility Principle: by loading in and enumerating over a properties file, instantiating new instances of problem classes, and handling all the exceptions which can be thrown. There will definately be some room for improvement there.</p>

<p>Getting back to the main <em>Euler </em>class as a whole, there is an even worse problem...</p>

<p>There are no unit tests!</p>

<p>This is a disastrous situation, because it means I cannot refactor the class with any confidence. The me of 18 months ago has a lot to answer for. I've got a bit of work to do. Check back next time to see how I've progressed things.</p>

<p style="text-align: left;"></p>
 
   <hr />
</div><!--/.post-->

  <!-- Pagination links -->
  <div id="post-pagination" class="pagination">

   
      <p class="previous">
        <a href="/page4">Previous Page</a>
        </p>


    <p class="previous">
      <a href="/page6">Next Page</a>
    </p>

  </div>


        
        <hr />
        <footer>
            <p>&copy; temporalcohesion.co.uk 2014 | Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a></p>
        </footer>

    </div><!-- /.container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>

    <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-9870754-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>

    <script src="/javascripts/prettify.js"></script>
    <script type='text/javascript'>
      $(function () {
        $("pre code").parent().each(function () {
          if (!$(this).hasClass("prettyprint")) {
            $(this).addClass("prettyprint");
            a = true
          }
        });

        prettyPrint();
      });
    </script>
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?skin=sons-of-obsidian"></script>

    <script src="/javascripts/cohesion.js"></script>
</body>
</html>
